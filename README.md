# ITK Health Management System by Juan Pablo TA

A health management system is used to improve the organization structure and performance for the patients and medical staff daily tasks.

## Getting started
### Clone the repo
```console
git clone https://github.com/JuanTututi-Ksquare/hms_itk
```

### Install Node Dependencies

It is necessary to install all the node dependencies
```console
npm install
```

Also it is necesary to install Typescript either as a global dependency on your system or as a dev dependency on the project

#### Global installation
```console
npm install -g typescript
```

#### Install as a dev dependency
```console
npm install --save-dev typescript
```

### Before Starting the API
#### Creating the database
This API uses PostgreSQL to manage the database data. It is necessary to install PostgreSQL and create a database that corresponds the reference created inside the project:

```console
CREATE DATABASE hms_itk;
```

#### Preparing the data
This API uses a Super User to perform certain tasks, for example, create new Admin users. This SU must be created using Firebase and must be registered in our database.

You need to register the user using Firebase Auth, once you have registered it, firebase will create a UID that references the user, also it will have an email and password. Please keep this information secret!

It is necessary that the email of the SU is kept as a Environment Variable in order to be checked for some of the middlewares:

```env
SUPER_USER="deus-ex-machina@admin.com"
```

The password for logging in as a SU is the following:

```ts
{
  pw: "Post1984@"
}
```

In the next section, you will find the id of the user for the function where it is needed.

#### Setting the SU in the project
In order to insert the SU inside of our database we need locate the file "PopulateModels.config.ts" it can be found inside /src/config folder. There you will find a function where you need to type the data for your SU, in this case all the information about the SU is already inside the code of the file:

```ts
export const createSU = async () => {
  const super_user = await Users.findOrCreate({
    where: {
      id: "PuZdRtsIAtXAUxNd1Jmc0okbPxs2" // This is the id for the SU
    },
    defaults: {
      id: "PuZdRtsIAtXAUxNd1Jmc0okbPxs2",
      birthdate: new Date("1984-12-24"),
      first_name: "Deus",
      last_name: "Machina",
    }
  });
  Admins.findOrCreate({
    where: {
      id_user: "PuZdRtsIAtXAUxNd1Jmc0okbPxs2" // This is the id of the SU
    }, 
    defaults: {
      id_user: "PuZdRtsIAtXAUxNd1Jmc0okbPxs2" // This is the id of the SU
    } 
  })
}
```

This will automatically register the SU in the database when we start the server. Then if we restart the server it will prevent the SU to be registered again thanks to the squelize function [findOrCreate()]

You also need to have a Google Credential File for using Firebase. You can get it by entering the link and following the instructions:

https://firebase.google.com/docs/admin/setup#:~:text=In%20the%20Firebase%20console%2C%20open,confirm%20by%20clicking%20Generate%20Key.


Once you have configured the SU for the project and added your Credentials file to the enviroment variables, you are ready to start the API.

#### Current state of the Firebase Auth system
The firebase Auth System will be initialized with the following users:



### Starting the API Service

#### Compile the files
It is necessary to compile the files with Typescript. Enter the following command on your terminal to automatically compile all the files within the /src folder
```console
tsc
```

#### Run the server
Now that Typescript has compiled all the files, our server is ready to be launched. Enter the following command in your terminal to start the development server
```console
npm start
```

or

```console
npm run start
```

The server will be initialized in a development enviroment were it can track the changes made on /src folder and automatically compile them to your local /dist folder.


## Endpoints
All the available endpoints can be found inside a Insomnia Collection, this collection can be found inside the repository files with the name: "Insomnia_2022-05-26.json". It can be imported using Insomnia or Postman.

In order to be able to use most of the endpoints for this API you need to have a JWT generated by Firebase Auth, using [signInWithEmailAndPassword] method, depending on the user role they will be able to access -or not- to the different endpoints. The token needs to be sent as a Bearer token to the API for authentication and further authorization.

## Data Modelling

In order to create this management system we need to define and model the data that is going to be used.

V2: Since the authentication module is now being managed by firebase there have been some changes in the general structure of Data Modelling.

### Roles

Every user will be assigned to a role when it's created, this model will help us to know what's the role of each user and the permissions that will be granted as a member of that role. For this particular scenario we'll be using three different roles: Patient, Doctor and Admin.

V2: This data model will now be managed by Firebase Account API, but the general structure remains the same

#### Role: Patient
The role of Patient will only have permission to create new appointments and consult previous appointments. 

#### Role: Doctor
The role of Doctor will have the permission to see it's active appointments and previous appointments. 

#### Role: Admin
The Admin role will have permissions to see all Patient and Doctor users, alongside all the appointments. Also he will be able to add new Doctor users and see the messages sent via the contact module.

```ts
type Role = "Patient" | "Doctor" | "Admin";
```

The role of the user will be assigned when it's created using Firebase;

### Users

Since this management system is going to be accesed by many users, we need to define a model to store not only the credentials for the user but also it's role in the system.

This model will extend the 'Role' model to know the role of each user in the system.

V2: Some of the properties used for this model will now be managed by Firebase Account API.

#### Firebase
```ts
interface User {
  uid: number;
  displayName: string;
  email: string;
  password: string;
  role: Role;
}
```

#### HMS_ITK REST API
#### Table - users
```ts
interface User{
  id: number; // References UID from Firebase
  first_name: string;
  last_name: string;
  birthdate: Date;
  is_deleted: boolean; // This property will help us to handle soft-deletes
}
```

### Patients

The Patients model will help us to store the personal information of each Patient user, this model will extend the properties of the 'User' model to get their credentials and basic info.

#### Table - patients
```ts
interface Patient {
  id: number; // PK AUTO_INCREMENTABLE
  id_user: number; //References id on table Users
  curp: string;
  nss?: string; // This property is optional and being evaluated for inclusion
}
```

### Doctors

This model will hold the personal information of each Doctor user, and it will allow the Admin users to consult their personal information, including availability and status, also this data will be useful to avoid showing Doctor users who are currently unavalible to the Patient users who are looking to book an appointment. Just like the previous interface, this will extend the 'User' model. 

#### Table - doctors
```ts
interface Doctor{
    id: number; // PK AUTO_INCREMENTABLE - DB
    id_user: number; //References id on table Users
    license_id: string; // This is a made up 10 long chars code to represent the doctors license
    id_area: enum Area; //
    availability: boolean; // (True - Not on vacation / False - On vacation or Day Off)
    status: boolean; // (True - Currently working in hospital / False - No longer working in hospital)
}
```

#### Table - area
```ts
interface Area {
  id_area: number; // PK AUTO_INCREMENTABLE
  area: string; // Name of the area  
}
```

#### ENUM - area
Predefined values for table area.

```ts
enum Area {
  Dermatology = "DERMATOLOGY",
  InternalMedicine = "INTERNAL MEDICINE",
  FamiliarMedicine = "FAMILIAR MEDICINE",
  Pediatry = "PEDIATRY",
  Gynecology = "GYNECOLOGY",
  PreventiveMedicine = "PREVENTIVE MEDICINE",
  Dentistry = "DENTISTRY",
  Radiology = "RADIOLOGY",
  Cardiology = "CARDIOLOGY"  
}
```

### Admin

This model will help us to store the personal information of each member of the administrative staff on the system, they will be able to see Patient and Doctor users, they will also be able to add new Doctor users and see the messages sent via the contact module.

This model will also extend the User model to include the credentials for each Admin user.

#### Table - admins
```ts
interface Admin extends User {
    id: number; // PK AUTO_INCREMENTABLE - DB
    id_user: // Refernces id on Users table
}
```

### Appointments

This model will be used to store all the information about the appointments, such as the Patient user requesting it, the Doctor user that will attend the appointment. Appointments can be created by Patient users and Doctor users.

#### Table - appointments
```ts
interface Appointment{
    id: number; // PK AUTO_INCREMENTABLE - DB
    id_doctor: number;
    id_patient: number;
    date: Date; // This will be the date of the appointment including date and time
    status: boolean; // (True - The appointment is still active / False - The appointment was completed or canceled)
}
```

### Contact

The contact model will help us to handle all the messages sent via the Contact module.

#### Table - contact
```ts
interface Contact {
  id: number; // PK AUTO_INCREMENTABLE - DB
  email: string;
  message: string; 
}
```
